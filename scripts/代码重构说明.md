# PyFstat脚本代码重构说明

## 重构原则（基于Linus Torvalds哲学）

1. **消除重复** - DRY原则，每个逻辑只写一次
2. **简洁明了** - 代码应该显而易见，而不是聪明
3. **单一职责** - 每个函数只做一件事
4. **最小嵌套** - 不超过2层缩进

## 主要改进

### 1. scripts/计算F统计量.py

#### 修复的问题
- **移除冗余参数**：删除了tref参数，自动从tstart和duration计算
- **统一imports**：将numpy import移到文件顶部
- **消除重复代码**：创建`compute_gradient`函数处理梯度计算
- **简化参数构建**：使用字典更新而非多个if分支

#### 代码质量提升
- 代码行数从127行减少到101行（减少21%）
- 消除了3段重复代码块
- 函数职责更清晰

### 2. scripts/绘制F统计量热图.py

#### 修复的问题
- **参数化硬编码值**：将固定参数改为命令行参数
- **消除重复逻辑**：创建`create_search_range`函数
- **统一边界处理**：创建`clip_delta_range`函数
- **简化嵌套判断**：从3层嵌套减少到1层

#### 代码质量提升
- 代码行数从181行减少到136行（减少25%）
- 消除了4段几乎相同的代码块（F0、F1、Alpha、Delta范围设置）
- 逻辑更清晰，维护更简单

### 3. scripts/common.py（新增）

#### 设计目的
- 集中管理共享常量和配置
- 提供通用工具函数
- 统一参数验证逻辑

#### 包含内容
- 默认参数定义
- 参数范围限制
- 通用计算函数
- 日志管理

## 性能影响

重构后的代码：
- **执行速度**：无明显变化（主要计算在C库中）
- **内存使用**：略有减少（减少了重复变量）
- **可维护性**：大幅提升

## 遵循的设计模式

1. **DRY (Don't Repeat Yourself)**
   - 每个知识片段在系统中只有单一、明确的表示

2. **KISS (Keep It Simple, Stupid)**
   - 简单的解决方案优于复杂的

3. **YAGNI (You Aren't Gonna Need It)**
   - 不添加当前不需要的功能

## 后续建议

1. 考虑将更多硬编码值参数化
2. 添加参数验证（但不要防御性编程）
3. 考虑并行化GridSearch的多维搜索

## 总结

通过这次重构，代码变得更加：
- **简洁** - 减少了约23%的代码量
- **清晰** - 逻辑更直观
- **可维护** - 修改一处即可影响所有相关代码
- **专业** - 符合工业级代码标准

记住Linus的话："好品味是让特殊情况消失，变成正常情况。"